{
    "sourceFile": "front/js/cart.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1678274221641,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1678274221641,
            "name": "Commit-0",
            "content": "\n\n// Chargement du localStorage\nlet panier = localStorage.getItem(\"panier\") \nif(panier) panier = JSON.parse(panier);\nconsole.log(\"panier\",panier)\n\n\nloadPage()\n\n// Chargement de la page panier en allant chercher les produits de l'API mentionnés dans le panier \nasync function loadPage(){\n    let priceTotal = 0\n    let numberTotal = 0\n    if(!panier || panier.length  === 0 ) return ;\n    for await (let item of panier){\n        let product = await fetch(\"http://localhost:3000/api/products/\"+item.id)\n            .then((res) => res.json())\n        \n       makeArticle(product, item)\n       updateTotalPriceQuantity()\n    }\n}\n//***********  MISE EN PAGE DE L'ARTICLE (modification du DOM) *******************\n\nasync function makeArticle(product, item){\n    await fetch(\"http://localhost:3000/api/products/\"+product._id)\n    .then((res) => res.json())\n    \n    const Article = document.createElement(\"article\")\n        Article.classList.add(\"cart__item\")\n        Article.dataset.id = product._id\n        Article.dataset.color = item.color\n        document.getElementById(\"cart__items\").appendChild(Article)\n\n        const divImg = document.createElement(\"div\")\n              divImg.classList.add(\"cart__item__img\")\n                const image = document.createElement(\"img\")\n                image.src = product.imageUrl\n                image.alt = product.altxt\n              divImg.appendChild(image)\n        \n        const contentDiv = document.createElement('div')\n              contentDiv.classList.add(\"cart__item__content\")\n\n              const descriptionDiv = document.createElement(\"div\")\n                    descriptionDiv.classList.add(\"cart__item__content__description\")\n                    const h2= document.createElement(\"h2\")\n                          h2.textContent = product.name\n                    const p = document.createElement(\"p\")\n                          p.textContent = item.color\n                    const p2 = document.createElement(\"p\")\n                          p2.textContent = (product.price) + \"€\" //prix en rapport avec la quantité\n                          \n              const settingsDiv = document.createElement(\"div\")\n                    settingsDiv.classList.add(\"cart__item__content__settings\")\n                        const settingsQuantityDiv = document.createElement(\"div\")\n                              settingsQuantityDiv.classList.add(\"cart__item__content__settings__quantity\")\n                        const quantityP = document.createElement(\"p\")\n                              quantityP.textContent =\"Qté : \"\n \n\n//***********  quantityInput   *******************       \n\n                const input = document.createElement(\"input\")\n                input.type = \"number\"\n                input.classList.add(\"itemQuantity\")\n                input.name =\"itemQuantity\"\n                input.min =\"1\"\n                input.max =\"100\"\n                input.value = item.quantity\n                input.addEventListener(\"change\",   function(event) {\n                   // TODO  VERIFICATION CHAMP QUANTITY\n              //      location.reload();\n                    const article = event.target.closest(\"article.cart__item\")\n                    const productId = article.dataset.id\n                    const productColor = article.dataset.color\n                    \n                    const itemToDelete = panier.findIndex(product =>\n                        productId === product.id && productColor === product.color)\n                    if(itemToDelete !== -1){\n                        panier[itemToDelete].quantity = this.value\n                        savePanier(panier)\n                        updateTotalPriceQuantity()\n                    }\n                })\n//***********      deleteProduct(item)   *******************  \n\n        const contentDelete = document.createElement(\"div\")\n        contentDelete.classList.add(\"cart__item__content__settings__delete\")\n            const deleteP = document.createElement(\"p\")\n            deleteP.classList.add(\"deleteproduct\")\n            deleteP.textContent =\"Supprimer\"\n            deleteP.addEventListener(\"click\", function(event){\n                const article = event.target.closest(\"article.cart__item\")\n                const productId = article.dataset.id\n                const productColor = article.dataset.color\n                console.log(productColor)\n                const itemToDelete = panier.findIndex(product =>\n                productId === product.id && productColor === product.color)\n\n                if(itemToDelete !== -1){\n                    panier.splice(itemToDelete, 1)\n                    article.remove()\n                    savePanier(panier)\n                    updateTotalPriceQuantity()\n                }\n            })\n//***********Fin de deleteProduct(item)  *******************  \n                     \n        appendtoArticle(Article, [divImg, contentDiv])\n        appendtoArticle(contentDiv, [descriptionDiv, settingsDiv])\n        appendtoArticle(settingsDiv, [settingsQuantityDiv, contentDelete])\n        appendtoArticle(descriptionDiv, [h2, p, p2])\n        appendtoArticle(settingsQuantityDiv, [quantityP, input])\n        appendtoArticle(contentDelete, [deleteP])\n                        \n       // return { number : item.quantity, price: product.price}\n}   \n//***********Fin de MISE EN PAGE DE L'ARTICLE  *******************\nfunction appendtoArticle(article, array) {\n    array.forEach(item => {\n    article.appendChild(item)\n})\n}\nfunction displayTotalPrice(price){\n    const totalPrice = document.querySelector(\"#totalPrice\")\n    totalPrice.textContent = price \n }\n function displayTotalQuantity(quantity){\n    const totalQuantity = document.querySelector(\"#totalQuantity\")\n          totalQuantity.textContent = quantity\n }\nasync function updateTotalPriceQuantity(id, newValue, item){\n      let priceTotal = 0\n      let numberTotal = 0\n      for await (let item of panier){\n          let product = await fetch(\"http://localhost:3000/api/products/\"+item.id)\n              .then((res) => res.json())\n         priceTotal += Number(product.price)* Number(item.quantity);\n        numberTotal += Number(item.quantity);\n      }\n      displayTotalQuantity(numberTotal)\n      displayTotalPrice(priceTotal)\n}\n\nfunction savePanier(panier){\n    localStorage.setItem(\"panier\", JSON.stringify(panier))\n}\n\n\n//*********Envoyer la commande après vérification du formulaire *******\n   \n    const orderButton = document.querySelector(\"#order\")\n          orderButton.addEventListener(\"click\", (e) => submitForm(e))\n\nfunction submitForm(e){\n    e.preventDefault() //ne pas rafraîchir\n    if(!panier || panier.length  === 0 )  alert (\"Vous devez retourner à la page d'accueil pour sélectionner votre canapé\")\n    //return\n    \n    if (formIsInvalid()) return;\n\n  //  if (!emailIsInvalid()) return\n\n    \n    let body = makeRequestBody()\n    body = JSON.stringify(body),\n\n    fetch(\"http://localhost:3000/api/products/order\",{\n        method : \"POST\",\n        body: body,\n        headers:{\n            \"Accept\": \"application/json\",\n            \"Content-Type\":\"application/json\"\n        }\n    })\n    .then((res) => res.json())\n    .then((data) => {\n        console.log(\"data\",data)\n    const orderId = data.orderId\n    window.location.href = \"confirmation.html\" + \"?orderId=\" + orderId\n    })\n    .catch((err) => console.error(err))\n}\nfunction formIsInvalid(){\n    let hasError = false;\n    const form = document.querySelector(\".cart__order__form\")\n    const inputs = form.querySelectorAll(\"input\")\n    inputs.forEach((input) =>{\n        if(input.id ===\"order\") return;\n        let errorElement =  document.getElementById(`${input.id}ErrorMsg`);\n        errorElement.innerText = '';\n        if (input.value === \"\"){\n            errorElement.innerText = \"Ce champ ne doit pas être vide!\";\n            hasError = true;\n        }\n        if(input.id === \"email\" && input.value !== \"\"){\n            const email = document.querySelector(\"#email\").value\n            const regex = /^\\w+([\\.-]?\\w+)*@\\w+([\\.-]?\\w+)*(\\.\\w{2,3})+$/\n            if (regex.test(email) === false) {\n                document.getElementById(`${input.id}ErrorMsg`).innerText = \"Ce champ doit un email!\"\n                hasError = true;\n            }\n        }\n    })\n    return hasError;\n}\nfunction emailIsInvalid(){\n    const email = document.querySelector(\"#email\").value\n    const regex = /^\\w+([\\.-]?\\w+)*@\\w+([\\.-]?\\w+)*(\\.\\w{2,3})+$/\n    if (regex.test(email) === false) {\n        alert (\"Votre adresse mail n'est pas valide\")\n        return true\n    }\n    return false\n}\n\nfunction makeRequestBody(){\n    //const form = document.querySelector(\"cart__order__form\")\n    inputFirstame = document.getElementById(\"firstName\").value;\n    inputLastname = document.getElementById(\"lastName\").value;\n    inputAddress = document.getElementById(\"address\").value;\n    inputCity = document.getElementById(\"city\").value;\n    inputEmail = document.getElementById(\"email\").value;\n\n    return {\n    contact: {\n        firstName: inputFirstame,\n        lastName: inputLastname,\n        address: inputAddress,\n        city: inputCity,\n        email: inputEmail\n        },\n        products: getIdsFromCache()\n    }\n\n}\nfunction getIdsFromCache(){\n        const ids = []\n        for (let item of panier){\n            ids.push(item.id)\n        }\n        return ids\n }\n\n"
        }
    ]
}